{% extends 'base.html' %}

{% block title %}‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô - Boonyisa Hotel{% endblock %}

{% block content %}
	<main class="container my-5">
		<div class="row">
			<div class="col-lg-8">
				<!-- Current Bookings (Session) -->
				<div class="mb-5">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h2 class="mb-0">üìã ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà)</h2>
						<small class="muted-small">‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ <strong>{{ bookings|length }}</strong> ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</small>
					</div>

					{% if bookings %}
						{% for booking in bookings %}
						<div class="booking-item mb-3 p-3 d-flex gap-3 align-items-center">
							<div class="booking-thumb d-flex align-items-center justify-content-center">
								<div class="emoji">üè®</div>
							</div>
							<div class="booking-meta flex-grow-1">
								<div class="d-flex justify-content-between align-items-start">
									<h5 class="mb-1">{{ booking.room_name }}</h5>
									<span class="badge bg-info text-dark">{{ booking.room_type }}</span>
								</div>
								<div class="small text-muted mt-1">üë• {{ booking.guests }} ‚Ä¢ üìÖ {{ booking.check_in|format_date }} ‚Üí {{ booking.check_out|format_date }}</div>
								<div class="mt-2 d-flex justify-content-between align-items-center">
									<div class="small text-muted">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Ñ‡∏∑‡∏ô</div>
									<div class="fw-bold text-success">‡∏ø{{ '%.2f'|format(booking.price_per_night) }}</div>
								</div>
							</div>
							<div class="booking-actions text-end ms-3 d-flex flex-column align-items-end gap-2">
								<div class="price-summary">‡∏£‡∏ß‡∏°: <strong class="text-success">‡∏ø{{ '%.2f'|format(booking.total) }}</strong></div>
								<div class="d-flex gap-2">
									<a href="{{ url_for('view_booking') }}" class="btn btn-outline-primary btn-sm">üîç ‡∏î‡∏π</a>
									<form method="POST" action="{{ url_for('cancel_booking', booking_index=loop.index0) }}">
										<button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
									</form>
								</div>
							</div>
						</div>
						{% endfor %}
					{% else %}
						<div class="card p-4 text-center">
							<p class="small text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà</p>
						</div>
					{% endif %}
				</div>

				<!-- Historical Bookings (Database) -->
				{% if historical_bookings %}
				<div class="mb-5">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h3 class="mb-0">üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
						<small class="muted-small">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>{{ historical_bookings|length }}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small>
					</div>

					{% for booking in historical_bookings %}
					<div class="booking-item mb-3 p-3 d-flex gap-3 align-items-center" style="background-color: #f9f9f9; border-left: 4px solid #6c757d;">
						<div class="booking-thumb d-flex align-items-center justify-content-center">
							<div class="emoji">‚úÖ</div>
						</div>
						<div class="booking-meta flex-grow-1">
							<div class="d-flex justify-content-between align-items-start">
								<h5 class="mb-1">{{ booking.room_name }}</h5>
								<span class="badge bg-success text-white">{{ booking.status.upper() }}</span>
							</div>
							<div class="small text-muted mt-1">üë• {{ booking.guests }} ‚Ä¢ üìÖ {{ booking.check_in|format_date }} ‚Üí {{ booking.check_out|format_date }}</div>
							<div class="mt-2">
								<small class="text-muted d-block">‡∏à‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: {{ booking.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
								<small class="text-muted d-block">{{ booking.nights }} ‡∏Ñ‡∏∑‡∏ô ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Ñ‡∏∑‡∏ô ‡∏ø{{ '%.2f'|format(booking.price_per_night) }}</small>
							</div>
						</div>
						<div class="booking-actions text-end ms-3">
							<div class="price-summary">‡∏£‡∏ß‡∏°: <strong class="text-success">‡∏ø{{ '%.2f'|format(booking.total_price) }}</strong></div>
						</div>
					</div>
					{% endfor %}
				</div>
				{% endif %}
			</div>

			<div class="col-lg-4">
				<div class="card p-4 sticky-top summary-card" style="top:90px">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h5 class="mb-0">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h5>
						<span class="small text-muted">{{ bookings|length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
					</div>

					<div class="summary-body">
						<div class="mb-3 small text-muted">‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
						<div class="summary-breakdown">
							<div class="d-flex justify-content-between align-items-center">
								<div class="text-muted">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</div>
								<div class="fw-bold">{{ bookings|length }}</div>
							</div>
							<div class="d-flex justify-content-between align-items-center mt-2">
								<div class="text-muted">‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
								<div class="fw-bold">{{ bookings|sum(attribute='nights') if bookings else 0 }}</div>
							</div>
						</div>

						<div class="divider my-3"></div>

						<div class="summary-total p-3 text-center">
							<div class="small text-muted">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div>
							<div class="h4 text-success mb-0">‡∏ø{{ '%.2f'|format(total_price if total_price else 0) }}</div>
						</div>

						<div class="mt-3 d-grid gap-2 summary-actions">
							{% if bookings %}
								<a href="{{ url_for('checkout') }}" class="btn btn-primary btn-lg">üí≥ ‡πÑ‡∏õ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</a>
								<form method="POST" action="{{ url_for('clear_bookings') }}">
									<button type="submit" class="btn btn-outline-secondary w-100">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
								</form>
							{% else %}
								<a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">üè® ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</a>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>
{% endblock %}
